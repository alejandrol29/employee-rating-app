<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Califica tu atención</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    .employee-card img {
      width: 100%;
      height: auto;
      border-radius: 1rem;
    }
    .star {
      font-size: 2rem;
      cursor: pointer;
      color: lightgray;
    }
    .star.selected {
      color: gold;
    }
  </style>
</head>
<body class="bg-light">
    <button class="btn btn-outline-secondary float-end" onclick="logout()">Cerrar sesión</button>
    <div class="container py-4">
      <h2 class="text-center mb-4">¿Quién te atendió?</h2>
      <div id="employee-list" class="row g-4"></div>
    </div>
  
    <!-- Modal -->
    <div class="modal fade" id="ratingModal" tabindex="-1" aria-labelledby="ratingModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="ratingModalLabel">Calificar atención</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <div class="modal-body">
            <p id="employeeName" class="fw-bold"></p>
            <div class="text-center" id="modalStars"></div>
            <div class="form-group mt-3">
              <label for="comment">Comentario (opcional)</label>
              <textarea id="comment" class="form-control" rows="3"></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button id="submitRating" class="btn btn-primary">Enviar</button>
          </div>
        </div>
      </div>
    </div>
  
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const token = localStorage.getItem('token');
        if (!token) {
        window.location.href = 'login.html';
    }
    function logout() {
        localStorage.removeItem('token');
        window.location.href = 'login.html';
    }
    const res = await fetch('/ruta-protegida', {
        headers: {
            'Authorization': `Bearer ${token}`
        }
    });

      let selectedEmployee = null;
      let selectedScore = 0;
  
      async function fetchEmployees() {
        const res = await fetch('/employees');
        return await res.json();
      }
  
      function renderEmployees(employees) {
        const list = document.getElementById('employee-list');
        list.innerHTML = '';
  
        employees.forEach(emp => {
          const card = document.createElement('div');
          card.className = 'col-12 col-sm-6 col-md-4 col-lg-3';
          card.innerHTML = `
            <div class="card h-100 employee-card p-2 shadow-sm text-center" style="cursor: pointer;" onclick="openModal(${emp.id}, '${emp.name}')">
                <img src="${emp.photoUrl}" alt="${emp.name}" />
                <div class="card-body">
                <h5 class="card-title">${emp.name}</h5>
                </div>
            </div>
            `;
          list.appendChild(card);
        });
      }
  
      function openModal(id, name) {
        selectedEmployee = id;
        selectedScore = 0;
  
        document.getElementById('employeeName').innerText = name;
        document.getElementById('comment').value = '';
        renderModalStars();
  
        const modal = new bootstrap.Modal(document.getElementById('ratingModal'));
        modal.show();
      }
  
      function renderModalStars() {
        const container = document.getElementById('modalStars');
        container.innerHTML = '';
  
        for (let i = 1; i <= 5; i++) {
          const star = document.createElement('span');
          star.innerHTML = '&#9733;';
          star.className = 'star';
          star.style.fontSize = '2rem';
          star.style.cursor = 'pointer';
          star.style.color = i <= selectedScore ? 'gold' : 'lightgray';
          star.onclick = () => {
            selectedScore = i;
            renderModalStars();
          };
          container.appendChild(star);
        }
      }
  
      async function submitRating() {
        if (!selectedEmployee || selectedScore === 0) {
          alert('Seleccioná una puntuación para continuar.');
          return;
        }
  
        const comment = document.getElementById('comment').value;
  
        const res = await fetch('/ratings', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            employeeId: selectedEmployee,
            score: selectedScore,
            comment: comment || null // si lo vas a usar más adelante
          })
        });
  
        if (res.ok) {
          alert('¡Gracias por tu calificación!');
          bootstrap.Modal.getInstance(document.getElementById('ratingModal')).hide();
        } else {
          alert('Error al enviar calificación');
        }
      }
  
      document.getElementById('submitRating').addEventListener('click', submitRating);
  
      fetchEmployees().then(renderEmployees);
    </script>
  </body>  
</html>
